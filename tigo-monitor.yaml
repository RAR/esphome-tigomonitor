esphome:
  name: tigo-monitor
  friendly_name: "Tigo Monitor"

esp32:
  board: esp32dev
  framework:
    type: arduino

# External components
external_components:
  - source: 
      type: local
      path: components

# WiFi configuration
wifi:
  ssid: "YOUR_WIFI_SSID"
  password: "YOUR_WIFI_PASSWORD"
  
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Tigo-Monitor Fallback Hotspot"
    password: "12345678"

captive_portal:

# Enable logging
logger:
  level: INFO  # Change to DEBUG if you need detailed logs for troubleshooting
  baud_rate: 0  # Disable hardware logging since we use the UART for Tigo communication

# Enable Home Assistant API
api:

# Enable OTA updates
ota:
  - platform: esphome
    password: "YOUR_OTA_PASSWORD"

# MQTT is handled natively by ESPHome through Home Assistant API
# No separate MQTT configuration needed

# Web Server (optional, basic ESPHome web interface)
web_server:
  port: 80

# UART configuration for Tigo communication
uart:
  id: tigo_uart
  tx_pin: GPIO1   # TX pin (same as original - pin 1)
  rx_pin: GPIO3   # RX pin (same as original - pin 3) 
  baud_rate: 38400
  data_bits: 8
  parity: NONE
  stop_bits: 1

# Tigo Monitor component - sensors will be created automatically!
tigo_monitor:
  id: tigo_hub
  uart_id: tigo_uart
  update_interval: 30s
  number_of_devices: 20  # Set this to exactly the number of Tigo devices you have

# Configure your sensors below - add individual device sensors and/or the power sum sensor

# Tigo Monitor Control Buttons
button:
  - platform: tigo_monitor
    name: "Generate YAML Config"
    id: generate_yaml_button
    tigo_monitor_id: tigo_hub
    button_type: yaml_generator
  - platform: tigo_monitor
    name: "Print Device Mappings"
    id: device_mappings_button
    tigo_monitor_id: tigo_hub
    button_type: device_mappings
  - platform: tigo_monitor
    name: "Reset Node Table"
    id: reset_node_table_button
    tigo_monitor_id: tigo_hub
    button_type: reset_node_table

# COPY THE GENERATED SENSOR YAML FROM LOGS HERE:
sensor:
  # NEW: Power Sum Sensor - Automatically calculates total power from all Tigo devices
  - platform: tigo_monitor
    tigo_monitor_id: tigo_hub
    name: "Total System Power"
    id: total_system_power
    # Optional: Add filters for smoothing
    filters:
      - sliding_window_moving_average:
          window_size: 5
          send_every: 1

  # NEW: Energy Sum Sensor - Automatically calculates total kWh produced by all Tigo devices
  - platform: tigo_monitor
    tigo_monitor_id: tigo_hub
    name: "Total System Energy"
    id: total_system_energy

  # NEW: Device Count Sensor - Shows the number of discovered Tigo devices
  - platform: tigo_monitor
    tigo_monitor_id: tigo_hub
    name: "Discovered Devices Count"
    id: discovered_devices_count

  # System monitoring sensors
  - platform: wifi_signal
    name: "Tigo Monitor WiFi Signal"
    update_interval: 60s

  - platform: uptime
    name: "Tigo Monitor Uptime"

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "Tigo Monitor IP Address"
    ssid:
      name: "Tigo Monitor Connected SSID"
  
  - platform: version
    name: "Tigo Monitor ESPHome Version"

# Optional: Binary sensors
binary_sensor:
  - platform: status
    name: "Tigo Monitor Status"

# Optional: Switches for control
switch:
  - platform: restart
    name: "Tigo Monitor Restart"

# Time component (optional, for logging timestamps)
time:
  - platform: sntp
    id: sntp_time
    timezone: "Europe/Berlin"  # Adjust for your timezone

